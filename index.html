<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>

    /* üî• FONDO DEPORTIVO BLANCO MODERNO */
    body{
      font-family: Arial;
      background: #ffffff;
      padding:40px;
      text-align:center;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:
        repeating-linear-gradient(
          120deg,
          rgba(37,99,235,0.04) 0px,
          rgba(37,99,235,0.04) 2px,
          transparent 2px,
          transparent 40px
        );
      z-index:-2;
      animation: moverLineas 20s linear infinite;
    }

    body::after{
      content:"‚öΩ üèÉ‚Äç‚ôÇÔ∏è üèÄ";
      position:fixed;
      bottom:30px;
      right:30px;
      font-size:120px;
      opacity:0.03;
      z-index:-1;
    }

    @keyframes moverLineas{
      from{ transform: translateX(0); }
      to{ transform: translateX(-200px); }
    }

    h1{
      font-size:40px;
      margin-bottom:5px;
      color:#1e3a8a;
      letter-spacing:1px;
    }

    h3{
      color:#2563eb;
      font-weight:normal;
    }

    input{
      padding:12px;
      width:320px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      font-size:16px;
      background:#f8fafc;
    }

    button{
      padding:12px 25px;
      border-radius:12px;
      border:none;
      background:linear-gradient(90deg,#2563eb,#06b6d4);
      color:white;
      font-size:16px;
      cursor:pointer;
      margin-top:15px;
      box-shadow:0 4px 12px rgba(37,99,235,0.3);
      transition:0.2s ease;
    }

    button:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 18px rgba(37,99,235,0.4);
    }

    .tabla-contenedor{
      width: 90%;
      margin: 40px auto;
      overflow-x: auto;
      border-radius: 14px;
      background: white;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
    }

    table{
      border-collapse:collapse;
      font-size:13px;
    }

    th, td{
      border:1px solid #e5e7eb;
      padding:6px 10px;
      text-align:center;
      white-space:nowrap;
      position:relative;
    }

    .icono-nota{
      color:#dc2626;
      font-weight:bold;
      margin-left:6px;
      cursor:pointer;
      font-size:14px;
    }

    .burbuja-nota{
      position:absolute;
      bottom:110%;
      left:50%;
      transform:translateX(-50%);
      background:white;
      color:#111;
      padding:10px 14px;
      border-radius:8px;
      box-shadow:0 8px 20px rgba(0,0,0,0.2);
      font-size:12px;
      width:220px;
      white-space:normal;
      text-align:left;
      z-index:999;
      display:none;
      animation:fadeIn 0.2s ease-in-out;
    }

    .burbuja-nota::after{
      content:"";
      position:absolute;
      top:100%;
      left:50%;
      transform:translateX(-50%);
      border-width:6px;
      border-style:solid;
      border-color:white transparent transparent transparent;
    }

    @keyframes fadeIn{
      from{opacity:0; transform:translate(-50%,5px);}
      to{opacity:1; transform:translate(-50%,0);}
    }

    .error{
      color:red;
      font-weight:bold;
      margin-top:20px;
    }

  </style>
</head>

<body>

<h4 class="institucion">
Unidad Educativa Municipal San Francisco de As√≠s
</h4>

<h1>SINSFA EDUCACI√ìN F√çSICA</h1>
<h3>Visor Acad√©mico</h3>

<input type="text" id="cedula" placeholder="Ingrese su n√∫mero de c√©dula">
<br>
<button onclick="buscar()">Buscar Calificaciones</button>

<div id="resultado"></div>
<footer class="footer-legal">
  ¬© Todos los derechos reservados ‚Äì Lcdo. Gabriel Quichimbo
</footer>

<script>

function buscar(){

  const cedula = document.getElementById("cedula").value.trim();

  if(!cedula){
    document.getElementById("resultado").innerHTML =
      "<div class='error'>Ingrese una c√©dula v√°lida.</div>";
    return;
  }

  document.getElementById("resultado").innerHTML = "Cargando...";

  google.script.run
  .withSuccessHandler(function(data){

    if(data.error){
      document.getElementById("resultado").innerHTML =
        "<div class='error'>"+data.error+"</div>";
      return;
    }

    let html = "<div class='tabla-contenedor'><table>";

    if(data.filaSuperior && data.filaSuperior.length){

      const alturaFila1 = data.alturasFilas?.[0] || 40;
      html += `<thead><tr style="height:${alturaFila1}px;">`;

      for(let i=0;i<data.filaSuperior.length;i++){

        const merge = data.merges?.find(m => m.start === i);
        const notaSuperior = data.filaSuperiorNotas?.[i] || "";
        const idUnico = "sup_" + i;

        let contenido = data.filaSuperior[i];

        if(notaSuperior){
          contenido += `
            <span class="icono-nota"
              onclick="toggleNota('${idUnico}')"
              onmouseover="mostrarNotaPC('${idUnico}')"
              onmouseout="ocultarNotaPC('${idUnico}')">
              üìå
            </span>
            <div class="burbuja-nota" id="${idUnico}">
              ${notaSuperior}
            </div>
          `;
        }

        if(merge){
          html += `<th colspan="${merge.colspan}"
                    style="background:${merge.bg};color:${merge.color};width:${data.anchosColumnas[i] || 100}px;">
                    ${contenido}
                  </th>`;
          i += merge.colspan - 1;
        } else {
          html += `<th style="background:${data.filaSuperiorColores?.[i] || ''};
                              color:${data.filaSuperiorTexto?.[i] || ''};
                              width:${data.anchosColumnas[i] || 100}px;">
                    ${contenido}
                  </th>`;
        }
      }

      html += "</tr>";
    }

    const alturaFila2 = data.alturasFilas?.[1] || 40;
    html += `<tr style="height:${alturaFila2}px;">`;

    data.headers.forEach((header, index)=>{

      const notaHeader = data.headersNotas?.[index] || "";
      const idUnico = "head_" + index;

      let contenido = header;

      if(notaHeader){
        contenido += `
          <span class="icono-nota"
            onclick="toggleNota('${idUnico}')"
            onmouseover="mostrarNotaPC('${idUnico}')"
            onmouseout="ocultarNotaPC('${idUnico}')">
            üìå
          </span>
          <div class="burbuja-nota" id="${idUnico}">
            ${notaHeader}
          </div>
        `;
      }

      html += `<th style="background:${data.headersColores?.[index] || ''};
                          color:${data.headersTexto?.[index] || ''};
                          width:${data.anchosColumnas[index] || 100}px;">
                ${contenido}
              </th>`;
    });

    html += "</tr></thead>";

    const alturaFilaDatos = data.alturasFilas?.[2] || 40;
    html += `<tbody><tr style="height:${alturaFilaDatos}px;">`;

    data.datos.forEach((valor, index)=>{

      const nota = data.notas?.[index] || "";
      const idUnico = "dato_" + index;

      let contenido = valor;

      const numero = parseFloat(String(valor).replace(",", "."));
      const esNumero = !isNaN(numero);
      const esNotaBaja = esNumero && numero >= 0 && numero < 6.99;
      const esPromedio = data.headers[index]?.toUpperCase().includes("PROM");

      if(esNotaBaja && !esPromedio){
        contenido += `
          <span style="color:#f59e0b; margin-left:6px; font-size:14px;">
            ‚ö†Ô∏è
          </span>
        `;
      }

      // üî• ACTUALIZACI√ìN: AHORA TODAS LAS CELDAS CON NOTA
      if(nota){
        contenido += `
          <span class="icono-nota"
            onclick="toggleNota('${idUnico}')"
            onmouseover="mostrarNotaPC('${idUnico}')"
            onmouseout="ocultarNotaPC('${idUnico}')">
            üìå
          </span>
          <div class="burbuja-nota" id="${idUnico}">
            ${nota}
          </div>
        `;
      }

      html += `<td style="background:${data.colores?.[index] || ''};
                          color:${data.coloresTexto?.[index] || ''};
                          width:${data.anchosColumnas[index] || 100}px;">
                ${contenido}
              </td>`;
    });

    html += "</tr></tbody>";
    html += "</table></div>";

    document.getElementById("resultado").innerHTML = html;

  })
  .withFailureHandler(function(err){
    document.getElementById("resultado").innerHTML =
      "<div class='error'>Error: "+err.message+"</div>";
  })
  .buscarPorCedula(cedula);

}

function toggleNota(id){
  const burbuja = document.getElementById(id);
  burbuja.style.display =
    burbuja.style.display === "block" ? "none" : "block";
}

function mostrarNotaPC(id){
  if(window.innerWidth > 768){
    document.getElementById(id).style.display = "block";
  }
}

function ocultarNotaPC(id){
  if(window.innerWidth > 768){
    document.getElementById(id).style.display = "none";
  }
}

</script>

</body>
</html>
